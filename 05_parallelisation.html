
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parallelisation &#8212; SWD6: High Performance Python</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="GPUs" href="06_GPUs.html" />
    <link rel="prev" title="Compilers" href="04_compilers.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">SWD6: High Performance Python</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   SWD6: High Performance Python
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="00_overview.html">
   Overview
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="01_profiling.html">
     Profiling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02_data_structures_algorithms_libraries.html">
     Data Structures, Algorithms, and Libraries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="03_vectorisation.html">
     Vectorisation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="04_compilers.html">
     Compilers
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Parallelisation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="06_GPUs.html">
     GPUs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_summary.html">
   Summary
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/05_parallelisation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/lukeconibear/swd6_hpp"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/lukeconibear/swd6_hpp/issues/new?title=Issue%20on%20page%20%2F05_parallelisation.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/lukeconibear/swd6_hpp/main?urlpath=tree/docs/05_parallelisation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-it">
   What is it?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelising-a-python">
   Parallelising a Python?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask">
   Dask
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#single-machine">
     Single machine
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#applications">
       Applications
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#local-profiling-and-diagnostics">
       Local profiling and diagnostics
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#visualise-the-task-graph">
         Visualise the task graph
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#interactive-dashboard">
         Interactive dashboard
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#static-profilers">
         <strong>
          Static profilers
         </strong>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#distributed">
     Distributed
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dask-mpi">
       Dask-MPI
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#submission-script">
         <strong>
          Submission script
         </strong>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#batch-job">
         <strong>
          Batch job
         </strong>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#distributed-profiling-and-diagnostics">
         <strong>
          Distributed profiling and diagnostics
         </strong>
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dask-jobqueue">
       Dask-Jobqueue
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#setup-the-config">
         <strong>
          Setup the config
         </strong>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id1">
         <strong>
          Submission script
         </strong>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id2">
         <strong>
          Batch job
         </strong>
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id3">
         <strong>
          Distributed profiling and diagnostics
         </strong>
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#functions-become-tasks">
     Functions become Tasks
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tasks-in-dask">
       Tasks in Dask
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classes-become-actors">
     Classes become Actors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#actors-in-dask">
       Actors in Dask
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ray">
     Ray
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tasks-in-ray">
       Tasks in Ray
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#actors-in-ray">
       Actors in Ray
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ray-put">
       <code class="docutils literal notranslate">
        <span class="pre">
         ray.put()
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ray-get">
       <code class="docutils literal notranslate">
        <span class="pre">
         ray.get()
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ray-wait">
       <code class="docutils literal notranslate">
        <span class="pre">
         ray.wait()
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ray-s-multiprocessing">
       Ray’s
       <code class="docutils literal notranslate">
        <span class="pre">
         multiprocessing
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallel-numba">
   Parallel Numba
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise">
   Exercise
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-information">
   Further information
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#useful-resources">
     Useful resources
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#good-practises">
     Good practises
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-options">
     Other options
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resources">
     Resources
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="parallelisation">
<h1>Parallelisation<a class="headerlink" href="#parallelisation" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/lukeconibear/swd6_hpp/blob/main/docs/06_parallelisation.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">IN_COLAB</span> <span class="o">=</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span>
<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="o">%</span><span class="k">pip</span> install dask[dataframe] joblib ray
</pre></div>
</div>
</div>
</div>
<div class="section" id="what-is-it">
<h2>What is it?<a class="headerlink" href="#what-is-it" title="Permalink to this headline">¶</a></h2>
<p>Parallelisation divides a large problem into many smaller ones and solves them <em>simultaneously</em>.</p>
<p>This <em>divides up the time/space complexity</em>.</p>
<p>These divided up tasks are centrally managed by a scheduler.</p>
<p>Can split the work across:</p>
<ul class="simple">
<li><p>Multiple <a class="reference external" href="https://en.wikipedia.org/wiki/Process_(computing)">processes</a> (cores)</p>
<ul>
<li><p>A process is the instance of a computer program that is being executed by one or many threads.</p></li>
<li><p>Useful for compute-bound problems.</p></li>
</ul>
</li>
<li><p>Multiple <a class="reference external" href="https://en.wikipedia.org/wiki/Thread_(computing)">threads</a> (parts of processes)</p>
<ul>
<li><p>A thread of execution is the smallest sequence of programmed instructions.</p></li>
<li><p>Useful for memory-bound problems.</p></li>
</ul>
</li>
</ul>
<a class="reference internal image-reference" href="_images/process-threads.png" id="process-threads"><img alt="_images/process-threads.png" id="process-threads" src="_images/process-threads.png" style="height: 300px;" /></a>
<p><em><a class="reference external" href="https://en.wikipedia.org/wiki/Thread_(computing)">Image source</a></em></p>
</div>
<div class="section" id="parallelising-a-python">
<h2>Parallelising a Python?<a class="headerlink" href="#parallelising-a-python" title="Permalink to this headline">¶</a></h2>
<p>Python itself is not designed for massive scalability and controls threads preemptively using the <a class="reference external" href="https://wiki.python.org/moin/GlobalInterpreterLock">Global Interpreter Lock, GIL</a>.</p>
<p>(The GIL prevents running the bytecode on mutliple threads simutaneously.)</p>
<p>This has lead many libraries to work around this using C/C++ backends.</p>
<p>Some options include:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a> for creating a pool of asynchronous workers.</p></li>
<li><p><a class="reference external" href="https://joblib.readthedocs.io/en/latest/">joblib</a> for creating lightweight pipelines that help with embaressingly parallel tasks.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> for concurrent programs, especially ones that are input/output bound.</p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#module-concurrent.futures">concurrent.futures</a> for launching parallel tasks.</p></li>
</ul>
<p>These options work well for the CPU cores on your machine, though not really beyond that.</p>
</div>
<div class="section" id="dask">
<h2><a class="reference external" href="https://docs.dask.org/en/latest/">Dask</a><a class="headerlink" href="#dask" title="Permalink to this headline">¶</a></h2>
<p>Dask has great features, helpful documentation, and a familiar API.</p>
<p>It works through creating and computing <a class="reference external" href="https://docs.dask.org/en/stable/graphs.html">task graphs</a>.</p>
<p>Task graphs have nodes (functions) and edges (objects).</p>
<p>For example, the task graph might be:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">Embarrassingly parallel</a> (apply one function to many pieces of data independently)</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/MapReduce">MapReduce</a> (map a function to the data and reduce / summarise the output)</p></li>
</ul>
<p><img alt="dask-task-graphs.svg" src="_images/dask-task-graphs.svg" /></p>
<p><em><a class="reference external" href="https://docs.dask.org/en/stable/graphs.html">Image source</a></em></p>
<p>These task graphs are executed by a <a class="reference external" href="https://docs.dask.org/en/stable/scheduling.html">scheduler</a>.</p>
<p>The resources used by this scheduler are managed by a cluster.</p>
<p><em>Note, this is separate to <a class="reference external" href="https://arcdocs.leeds.ac.uk/usage/start.html">ARC’s scheduler</a>.</em></p>
<p>There are two main types of Dask scheduler which can <a class="reference external" href="https://docs.dask.org/en/stable/deploying.html">deploy jobs</a>:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/deploying-python.html">Single machine</a></p>
<ul>
<li><p>Cluster manager: <a class="reference external" href="http://distributed.dask.org/en/stable/api.html#distributed.LocalCluster"><code class="docutils literal notranslate"><span class="pre">LocalCluster()</span></code></a></p></li>
<li><p>Simpler.</p></li>
<li><p>For your laptop or a local server.</p></li>
<li><p>Test things out here first.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/deploying-hpc.html">Distributed</a></p>
<ul>
<li><p>Cluster manager: <a class="reference external" href="http://jobqueue.dask.org/en/latest/generated/dask_jobqueue.SGECluster.html"><code class="docutils literal notranslate"><span class="pre">SGECluster()</span></code></a>, <a class="reference external" href="http://jobqueue.dask.org/en/latest/generated/dask_jobqueue.SLURMCluster.html"><code class="docutils literal notranslate"><span class="pre">SLURMCluster()</span></code></a></p></li>
<li><p>More complex.</p></li>
<li><p>For a cluster on a high performance computer (e.g., SGE, SLURM), Kubernetes, or cloud.</p></li>
<li><p>Once working correctly on a single machine, move over to distributed.</p></li>
</ul>
</li>
</ul>
<p><img alt="dask-cluster-manager.svg" src="_images/dask-cluster-manager.svg" /></p>
<p><em><a class="reference external" href="https://docs.dask.org/en/stable/deploying.html">Image source</a></em></p>
<div class="section" id="single-machine">
<h3><a class="reference external" href="https://docs.dask.org/en/stable/deploying-python.html">Single machine</a><a class="headerlink" href="#single-machine" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># if not in colab, can render the client and cluster information</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
    <div style="width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;"> </div>
    <div style="margin-left: 48px;">
        <h3 style="margin-bottom: 0px;">Client</h3>
        <p style="color: #9D9D9D; margin-bottom: 0px;">Client-392506a0-9020-11ec-8fc0-000d3a7a17b8</p>
        <table style="width: 100%; text-align: left;">

        <tr>

            <td style="text-align: left;"><strong>Connection method:</strong> Cluster object</td>
            <td style="text-align: left;"><strong>Cluster type:</strong> distributed.LocalCluster</td>

        </tr>


            <tr>
                <td style="text-align: left;">
                    <strong>Dashboard: </strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                </td>
                <td style="text-align: left;"></td>
            </tr>


        </table>


            <details>
            <summary style="margin-bottom: 20px;"><h3 style="display: inline;">Cluster Info</h3></summary>
            <div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output">
    <div style="width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;">
    </div>
    <div style="margin-left: 48px;">
        <h3 style="margin-bottom: 0px; margin-top: 0px;">LocalCluster</h3>
        <p style="color: #9D9D9D; margin-bottom: 0px;">a635d316</p>
        <table style="width: 100%; text-align: left;">
            <tr>
                <td style="text-align: left;">
                    <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                </td>
                <td style="text-align: left;">
                    <strong>Workers:</strong> 2
                </td>
            </tr>
            <tr>
                <td style="text-align: left;">
                    <strong>Total threads:</strong> 2
                </td>
                <td style="text-align: left;">
                    <strong>Total memory:</strong> 6.78 GiB
                </td>
            </tr>

            <tr>
    <td style="text-align: left;"><strong>Status:</strong> running</td>
    <td style="text-align: left;"><strong>Using processes:</strong> True</td>
</tr>


        </table>

        <details>
            <summary style="margin-bottom: 20px;">
                <h3 style="display: inline;">Scheduler Info</h3>
            </summary>

            <div style="">
    <div>
        <div style="width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;"> </div>
        <div style="margin-left: 48px;">
            <h3 style="margin-bottom: 0px;">Scheduler</h3>
            <p style="color: #9D9D9D; margin-bottom: 0px;">Scheduler-e4e8888d-6726-416d-a2f1-e0f4438b1c25</p>
            <table style="width: 100%; text-align: left;">
                <tr>
                    <td style="text-align: left;">
                        <strong>Comm:</strong> tcp://127.0.0.1:37761
                    </td>
                    <td style="text-align: left;">
                        <strong>Workers:</strong> 2
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Dashboard:</strong> <a href="http://127.0.0.1:8787/status" target="_blank">http://127.0.0.1:8787/status</a>
                    </td>
                    <td style="text-align: left;">
                        <strong>Total threads:</strong> 2
                    </td>
                </tr>
                <tr>
                    <td style="text-align: left;">
                        <strong>Started:</strong> Just now
                    </td>
                    <td style="text-align: left;">
                        <strong>Total memory:</strong> 6.78 GiB
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <details style="margin-left: 48px;">
        <summary style="margin-bottom: 20px;">
            <h3 style="display: inline;">Workers</h3>
        </summary>


        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 0</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:34053
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:35015/status" target="_blank">http://127.0.0.1:35015/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 3.39 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:38589
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /home/runner/work/swd6_hpp/swd6_hpp/docs/dask-worker-space/worker-d7z7u02b
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <div style="width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;"> </div>
            <div style="margin-left: 48px;">
            <details>
                <summary>
                    <h4 style="margin-bottom: 0px; display: inline;">Worker: 1</h4>
                </summary>
                <table style="width: 100%; text-align: left;">
                    <tr>
                        <td style="text-align: left;">
                            <strong>Comm: </strong> tcp://127.0.0.1:37549
                        </td>
                        <td style="text-align: left;">
                            <strong>Total threads: </strong> 1
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Dashboard: </strong> <a href="http://127.0.0.1:39065/status" target="_blank">http://127.0.0.1:39065/status</a>
                        </td>
                        <td style="text-align: left;">
                            <strong>Memory: </strong> 3.39 GiB
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align: left;">
                            <strong>Nanny: </strong> tcp://127.0.0.1:45497
                        </td>
                        <td style="text-align: left;"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: left;">
                            <strong>Local directory: </strong> /home/runner/work/swd6_hpp/swd6_hpp/docs/dask-worker-space/worker-laoyft35
                        </td>
                    </tr>





                </table>
            </details>
            </div>
        </div>


    </details>
</div>

        </details>
    </div>
</div>
            </details>


    </div>
</div></div></div>
</div>
<p>If want multiple threads, then could use keyword arguments in Client instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Note (important!), always need to close down the client and cluster at the end:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="applications">
<h4>Applications<a class="headerlink" href="#applications" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p><a class="reference external" href="https://examples.dask.org/array.html">dask.array</a> for NumPy</p></li>
<li><p><a class="reference external" href="https://examples.dask.org/dataframe.html">dask.dataframe</a> for Pandas</p></li>
<li><p><a class="reference external" href="https://examples.dask.org/bag.html">dask.bag</a> to iterate over a bag of independent objects (embarrassingly parallel).</p></li>
<li><p>Dask is under the hood for many libraries e.g., <a class="reference external" href="http://xarray.pydata.org/en/stable/dask.html">xarray</a>, <a class="reference external" href="https://scitools.org.uk/iris/docs/v2.4.0/userguide/real_and_lazy_data.html">iris</a>, <a class="reference external" href="https://ml.dask.org/">scikit-learn</a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
</pre></div>
</div>
</div>
</div>
<p>Here, out example is going to do some maths on arrays. Don’t worry about what it is. Just focus on the Dask bits.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Parallelised code often introduces overheads e.g., Dask’s scheduler and client. For small jobs, these can take up a large relative portion of the resources, making the job inefficient. It is worthwhile ensuring that the job is big enough that these overheads are small in comparison. The examples here in this tutorial are on the small side for teaching purposes.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
    <span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
    <span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,</span> <span class="mi">1_000</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">da</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="local-profiling-and-diagnostics">
<h4><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-local.html">Local profiling and diagnostics</a><a class="headerlink" href="#local-profiling-and-diagnostics" title="Permalink to this headline">¶</a></h4>
<p>Many of the profiling tools we looked at earlier don’t work well with parallel code.</p>
<p>Dask provides its own useful tools.</p>
<div class="section" id="visualise-the-task-graph">
<h5><a class="reference external" href="https://docs.dask.org/en/stable/graphviz.html">Visualise the task graph</a><a class="headerlink" href="#visualise-the-task-graph" title="Permalink to this headline">¶</a></h5>
<p>Before executing the computation, you could <code class="docutils literal notranslate"><span class="pre">.visualise()</span></code> the task graph.</p>
<p>This can help find potential bottlenecks.</p>
<p>For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dot: graph is too large for cairo-renderer bitmaps. Scaling by 0.333945 to fit
</pre></div>
</div>
<img alt="_images/05_parallelisation_22_1.png" src="_images/05_parallelisation_22_1.png" />
</div>
</div>
</div>
<div class="section" id="interactive-dashboard">
<h5><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-distributed.html">Interactive dashboard</a><a class="headerlink" href="#interactive-dashboard" title="Permalink to this headline">¶</a></h5>
<p>The Dask dashboard provides live feedback and diagnostics in many plots and tables using <a class="reference external" href="https://docs.bokeh.org/en/latest/">Bokeh</a>.</p>
<p>First, get the Dask dashboard address (normally <code class="docutils literal notranslate"><span class="pre">http://localhost:8787/status</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">dashboard_link</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://127.0.0.1:8787/status
</pre></div>
</div>
</div>
</div>
<p>Either show in a browser or copy the address into the <a class="reference external" href="https://github.com/dask/dask-labextension">Dask Lab Extension</a>.</p>
<p>The Dask Lab Extension should now show all of the client and cluster information.</p>
<p>You can place some of these panels to the side e.g.,:</p>
<ul class="simple">
<li><p>Task Stream</p></li>
<li><p>Progress</p></li>
<li><p>Workers</p></li>
</ul>
<p>Now, when you <code class="docutils literal notranslate"><span class="pre">.compute()</span></code> the task graph, you can view the progress in these dashboard panels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_4032</span><span class="o">/</span><span class="mf">4023212076.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">result</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/dask/base.py</span> in <span class="ni">compute</span><span class="nt">(self, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">286</span>         <span class="n">dask</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">compute</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>         <span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">288</span><span class="s2">         (result,) = compute(self, traverse=False, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span><span class="s2">         return result</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="s2"> </span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/dask/base.py</span> in <span class="ni">compute</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">568</span><span class="s2">         postcomputes.append(x.__dask_postcompute__())</span>
<span class="g g-Whitespace">    </span><span class="mi">569</span><span class="s2"> </span>
<span class="ne">--&gt; </span><span class="mi">570</span><span class="s2">     results = schedule(dsk, keys, **kwargs)</span>
<span class="nn">    571     return repack([f(r, *a) for r, (f, a)</span> in <span class="ni">zip</span><span class="nt">(results, postcomputes)])</span>
<span class="g g-Whitespace">    </span><span class="mi">572</span><span class="s2"> </span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/distributed/client.py</span> in <span class="ni">get</span><span class="nt">(self, dsk, keys, workers, allow_other_workers, resources, sync, asynchronous, direct, retries, priority, fifo_timeout, actors, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2720</span><span class="s2">                     should_rejoin = False</span>
<span class="g g-Whitespace">   </span><span class="mi">2721</span><span class="s2">             try:</span>
<span class="ne">-&gt; </span><span class="mi">2722</span><span class="s2">                 results = self.gather(packed, asynchronous=asynchronous, direct=direct)</span>
<span class="g g-Whitespace">   </span><span class="mi">2723</span><span class="s2">             finally:</span>
<span class="g g-Whitespace">   </span><span class="mi">2724</span><span class="s2">                 for f in futures.values():</span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/distributed/client.py</span> in <span class="ni">gather</span><span class="nt">(self, futures, errors, direct, asynchronous)</span>
<span class="g g-Whitespace">   </span><span class="mi">1975</span><span class="s2">             else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1976</span><span class="s2">                 local_worker = None</span>
<span class="ne">-&gt; </span><span class="mi">1977</span><span class="s2">             return self.sync(</span>
<span class="g g-Whitespace">   </span><span class="mi">1978</span><span class="s2">                 self._gather,</span>
<span class="g g-Whitespace">   </span><span class="mi">1979</span><span class="s2">                 futures,</span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/distributed/client.py</span> in <span class="ni">sync</span><span class="nt">(self, func, asynchronous, callback_timeout, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">863</span><span class="s2">             return future</span>
<span class="g g-Whitespace">    </span><span class="mi">864</span><span class="s2">         else:</span>
<span class="ne">--&gt; </span><span class="mi">865</span><span class="s2">             return sync(</span>
<span class="g g-Whitespace">    </span><span class="mi">866</span><span class="s2">                 self.loop, func, *args, callback_timeout=callback_timeout, **kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">867</span><span class="s2">             )</span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/site-packages/distributed/utils.py</span> in <span class="ni">sync</span><span class="nt">(loop, func, callback_timeout, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span><span class="s2">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span><span class="s2">         while not e.is_set():</span>
<span class="ne">--&gt; </span><span class="mi">324</span><span class="s2">             e.wait(10)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span><span class="s2">     if error[0]:</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span><span class="s2">         typ, exc, tb = error[0]</span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/threading.py</span> in <span class="ni">wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">572</span><span class="s2">             signaled = self._flag</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span><span class="s2">             if not signaled:</span>
<span class="ne">--&gt; </span><span class="mi">574</span><span class="s2">                 signaled = self._cond.wait(timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">575</span><span class="s2">             return signaled</span>
<span class="g g-Whitespace">    </span><span class="mi">576</span><span class="s2"> </span>

<span class="nn">/usr/share/miniconda/envs/swd6_hpp/lib/python3.9/threading.py</span> in <span class="ni">wait</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span><span class="s2">             else:</span>
<span class="g g-Whitespace">    </span><span class="mi">315</span><span class="s2">                 if timeout &gt; 0:</span>
<span class="ne">--&gt; </span><span class="mi">316</span><span class="s2">                     gotit = waiter.acquire(True, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">317</span><span class="s2">                 else:</span>
<span class="g g-Whitespace">    </span><span class="mi">318</span><span class="s2">                     gotit = waiter.acquire(False)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>The Dashboard shows:</p>
<p><strong>Task Stream</strong></p>
<ul class="simple">
<li><p>Each row is the activity on a process (core) or thread within the cluster over time.</p></li>
<li><p>Each rectangle is one task.</p></li>
<li><p>The different colours and different <em>types</em> of work:</p>
<ul>
<li><p>Idle (white)</p></li>
<li><p>Serialisation (grey)</p></li>
<li><p>Communication (red)</p></li>
<li><p>Disk input/output (orange)</p></li>
<li><p>Other tasks (other colours)</p></li>
</ul>
</li>
</ul>
<p><img alt="SegmentLocal" src="_images/bokeh-task-stream.gif" />
<em><a class="reference external" href="http://distributed.dask.org/en/stable/diagnosing-performance.html">Image source</a></em></p>
<p><strong>Progress</strong></p>
<ul class="simple">
<li><p>Progresses from left to right, with the task complete / total tasks.</p></li>
<li><p>Same colours as above, with grey for ready to run, darker colours for data in memory, and lighter colours for complete tasks released from memory.</p></li>
</ul>
<p><img alt="SegmentLocal" src="_images/bokeh-progress-large.gif" />
<em><a class="reference external" href="http://matthewrocklin.com/blog/work/2016/09/12/dask-distributed-release-1.13.0">Image source</a></em></p>
<p><strong>Workers</strong></p>
<ul class="simple">
<li><p>Shows the CPU percentage use (also per worker).</p></li>
<li><p>Shows the memory percentage use (also per worker).</p></li>
</ul>
<div class="admonition-question admonition">
<p class="admonition-title">Question</p>
<p>What do these specific results show?</p>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Solution</p>
<p>Our specific results show us that:</p>
<ul class="simple">
<li><p>All workers were full with numerical tasks (i.e., no white/red blocks).</p></li>
<li><p>This utilises the CPU cores well.</p></li>
</ul>
</div>
<p>There are lots of other useful information, such as (<a class="reference external" href="https://www.youtube.com/watch?v=N_GqzcuGLCY">video demonstration</a>):</p>
<ul class="simple">
<li><p><a class="reference external" href="http://distributed.dask.org/en/stable/diagnosing-performance.html#statistical-profiling">Profiler</a></p>
<ul>
<li><p>Statistical (sampling every 10ms) capture of the call stack from the Dask schedulers perspective</p></li>
</ul>
</li>
</ul>
<p><img alt="SegmentLocal" src="_images/daskboard-profile.gif" /></p>
<p><em><a class="reference external" href="http://distributed.dask.org/en/stable/diagnosing-performance.html">Image source</a></em></p>
<ul class="simple">
<li><p>System</p></li>
<li><p>Logs</p></li>
<li><p>Individual workers</p></li>
<li><p>etc.</p></li>
</ul>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Which is of the 3 examples below is most efficient and why?</p>
</div>
<div class="dropdown admonition hint">
<p class="admonition-title">Hint</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">%%time</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1: Many, small chunks</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1_000</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 2: Fewer, large chunks</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 3: NumPy</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Solution</p>
<ul class="simple">
<li><p>Dask introduces overhead to parallelise work (i.e., the scheduler and client).</p></li>
<li><p>Hence, Dask is inefficient (i.e., the workers are under-utilised) when doing lots of very small computations.</p></li>
<li><p>Consider using fewer, larger chunks to reduce this overhead.</p></li>
<li><p>Consider if parallelisation is really needed.</p></li>
</ul>
</div>
<p>If you want a shareable report of this interactive dashboard, you can use the <a class="reference external" href="http://distributed.dask.org/en/latest/diagnosing-performance.html#performance-reports">performance report</a> context manager.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">performance_report</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">performance_report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dask-report.html&quot;</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Can then view this performance report here or in a browser:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dask-report.html&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This can also be shared with colleagues:</p>
<ul class="simple">
<li><p>Create a <a class="reference external" href="https://gist.github.com/">Gist</a>.</p></li>
<li><p>Copy the contents of the <code class="docutils literal notranslate"><span class="pre">dask-report.html</span></code> into here.</p></li>
<li><p>Host the file e.g., provide the <code class="docutils literal notranslate"><span class="pre">Raw</span></code> address to <a class="reference external" href="https://raw.githack.com/">raw.githack.com</a>.</p></li>
</ul>
<p>For example, for this report click <a class="reference external" href="https://gistcdn.githack.com/lukeconibear/05f878a8b149178524c1508c37e204a3/raw/87f1f7c92f821773ccb67631f8757d1ca4a2404b/dask-report.html">here</a>.</p>
</div>
<div class="section" id="static-profilers">
<h5><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-local.html"><strong>Static profilers</strong></a><a class="headerlink" href="#static-profilers" title="Permalink to this headline">¶</a></h5>
<p>Returns local diagnostics that can viewed in the browser.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-local.html#dask.diagnostics.Profiler"><code class="docutils literal notranslate"><span class="pre">Profiler()</span></code></a> for task execution.</p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-local.html#dask.diagnostics.ResourceProfiler"><code class="docutils literal notranslate"><span class="pre">ResourceProfiler()</span></code></a> for resource use.</p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/diagnostics-local.html#dask.diagnostics.CacheProfiler"><code class="docutils literal notranslate"><span class="pre">CacheProfiler()</span></code></a> for scheduler cache.</p></li>
</ul>
<p><em>Note, the profilers are just context managers, so can use many in a with block.</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">Profiler</span><span class="p">,</span> <span class="n">ResourceProfiler</span><span class="p">,</span> <span class="n">CacheProfiler</span><span class="p">,</span> <span class="n">visualize</span>

<span class="k">with</span> <span class="n">Profiler</span><span class="p">()</span> <span class="k">as</span> <span class="n">prof</span><span class="p">,</span> <span class="n">ResourceProfiler</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span> <span class="k">as</span> <span class="n">rprof</span><span class="p">,</span> <span class="n">CacheProfiler</span><span class="p">()</span> <span class="k">as</span> <span class="n">cprof</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">random_array_reconstructed</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="n">visualize</span><span class="p">([</span><span class="n">prof</span><span class="p">,</span> <span class="n">rprof</span><span class="p">,</span> <span class="n">cprof</span><span class="p">])</span>
</pre></div>
</div>
<p>When happy that everything is correct on a single machine, can move over to distributed.</p>
<p>Remember, to close down the local client and cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>   
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="distributed">
<h3><a class="reference external" href="https://docs.dask.org/en/stable/deploying-hpc.html">Distributed</a><a class="headerlink" href="#distributed" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dask-mpi">
<h4><a class="reference external" href="http://mpi.dask.org/en/latest/">Dask-MPI</a><a class="headerlink" href="#dask-mpi" title="Permalink to this headline">¶</a></h4>
<p>Uses the <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/"><code class="docutils literal notranslate"><span class="pre">mpi4py</span></code></a> package and MPI to distribute the workers (not communication).</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">MPI (Message Passing Interface)</a> is where many systems send and receive messages (sometimes containing data) between processes with their own (private) memory.</p>
<p>It’s suitable for problems that require distributed memory. For example, if your computations are mostly Python code that don’t release the GIL.</p>
<p>MPI is parallelism <em>between</em> nodes (multi-process).</p>
<p><img alt="mpi.png" src="_images/mpi.png" /></p>
<p><em><a class="reference external" href="https://princetonuniversity.github.io/PUbootcamp/sessions/parallel-programming/Intro_PP_bootcamp_2018.pdf">Image source</a></em></p>
<p><code class="docutils literal notranslate"><span class="pre">mpi4py</span></code> provides MPI for Python, allowing Python applications to use multiple processes.</p>
<p>To use MPI in batch jobs, you can specify the <a class="reference external" href="https://arcdocs.leeds.ac.uk/usage/batchjob.html#list-of-sge-options">number of cores</a> using <code class="docutils literal notranslate"><span class="pre">-pe</span> <span class="pre">ib</span></code> via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -pe ib np</span>
</pre></div>
</div>
<p>When you need to <a class="reference external" href="https://docs.dask.org/en/latest/shared.html">share memory</a> across chunks, you can use use <a class="reference external" href="https://en.wikipedia.org/wiki/OpenMP">OpenMP (Open Multi-Processing)</a>.</p>
<p>It’s suitable for problems that are mostly numeric (e.g., NumPy and Pandas) that release the GIL entirely.</p>
<p>OpenMP is parallelism <em>within</em> nodes (multi-thread).</p>
<p><img alt="openmp.png" src="_images/openmp.png" /></p>
<p><em><a class="reference external" href="https://princetonuniversity.github.io/PUbootcamp/sessions/parallel-programming/Intro_PP_bootcamp_2018.pdf">Image source</a></em></p>
<p>To use OpenMP in batch jobs, you can specify the <a class="reference external" href="https://arcdocs.leeds.ac.uk/usage/batchjob.html#list-of-sge-options">number of cores</a> using <code class="docutils literal notranslate"><span class="pre">-pe</span> <span class="pre">smp</span></code> via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -pe smp np</span>
</pre></div>
</div>
<div class="section" id="submission-script">
<h5><strong>Submission script</strong><a class="headerlink" href="#submission-script" title="Permalink to this headline">¶</a></h5>
<p>Initialise a Dask MPI session and connect a client.</p>
<p>The initialisation launches the Dask Scheduler on MPI rank 0, the user’s Client code on MPI rank 1, and the Dask Workers on MPI ranks 3 and above.</p>
<p>So, for 8 processes, there will be 6 workers.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask_mpi</span> <span class="kn">import</span> <span class="n">initialize</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="n">initialize</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</pre></div>
</div>
<p>Then add in your Dask work.</p>
<p>Here, we use a bigger job for Dask. This increases efficiency, by reducing the relative size of Dask’s overheads (scheduler and client).</p>
<p>Ensure to have the <code class="docutils literal notranslate"><span class="pre">.compute()</span></code> call within the <code class="docutils literal notranslate"><span class="pre">performance_report</span></code> context manager to capture the diagnostics.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">performance_report</span>


<span class="k">def</span> <span class="nf">example_function</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="mi">100_000</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="mi">100_000</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">10_000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">da</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">performance_report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dask-report_mpi.html&quot;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">example_function</span><span class="p">()</span>
</pre></div>
</div>
<p>The full script can be found in <a class="reference external" href="https://github.com/lukeconibear/swd6_hpp/blob/main/docs/example_dask_mpi_sge.py"><code class="docutils literal notranslate"><span class="pre">example_dask_mpi_sge.py</span></code></a>.</p>
</div>
<div class="section" id="batch-job">
<h5><strong>Batch job</strong><a class="headerlink" href="#batch-job" title="Permalink to this headline">¶</a></h5>
<p>Setup the resource request from the HPC scheduler:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -l</span>
<span class="c1">#$ -cwd -V</span>
<span class="c1">#$ -l h_rt=01:00:00</span>
<span class="c1">#$ -pe smp 8</span>
<span class="c1">#$ -l h_vmem=24G</span>
</pre></div>
</div>
<p>Load an MPI module e.g.,:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load intel openmpi
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Issues can arise from oversubscribing threads.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ensure linear algebra libraries using 1 thread</span>
<span class="c1"># https://docs.dask.org/en/stable/array-best-practices.html#avoid-oversubscribing-threads</span>
<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Load the conda environment e.g.,:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate swd6_hpp
</pre></div>
</div>
<p>Ensure that number of cores match in the requested resources at the top and in the <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> call e.g.,:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#$ -pe smp 8</span>

mpirun -np <span class="m">8</span> python example_dask_mpi_sge.py
</pre></div>
</div>
<p>The full script can be found in <a class="reference external" href="https://github.com/lukeconibear/swd6_hpp/blob/main/docs/example_dask_mpi_sge.bash"><code class="docutils literal notranslate"><span class="pre">example_dask_mpi_sge.bash</span></code></a>.</p>
</div>
<div class="section" id="distributed-profiling-and-diagnostics">
<h5><strong>Distributed profiling and diagnostics</strong><a class="headerlink" href="#distributed-profiling-and-diagnostics" title="Permalink to this headline">¶</a></h5>
<p>View the Dask performance report <a class="reference external" href="https://gistcdn.githack.com/lukeconibear/5551a7a54279c8f0267d32061d73fba1/raw/59d1a1b5be18bf6d3ceb29591613d2f98398c63d/dask-report_mpi.html">here</a>.</p>
<p>You can see the 6 workers, and the diagnostics look similar to that for the local machine.</p>
</div>
</div>
<div class="section" id="dask-jobqueue">
<h4><a class="reference external" href="http://jobqueue.dask.org/en/latest/">Dask-Jobqueue</a><a class="headerlink" href="#dask-jobqueue" title="Permalink to this headline">¶</a></h4>
<p>Dask-Jobqueue support a variety of resource managers (e.g., <a class="reference external" href="http://jobqueue.dask.org/en/latest/examples.html#sge-deployments">SGE</a>, <a class="reference external" href="http://jobqueue.dask.org/en/latest/examples.html#slurm-deployments">SLURM</a>).</p>
<p>We recommend you use it for batch jobs on the HPC, rather than interactive jobs.</p>
<p>Though it does have lots of nice features for interactive work e.g., adaptive dynamic scaling of workers.</p>
<div class="section" id="setup-the-config">
<h5><strong><a class="reference external" href="http://jobqueue.dask.org/en/latest/configuration.html">Setup the config</a></strong><a class="headerlink" href="#setup-the-config" title="Permalink to this headline">¶</a></h5>
<p>The example below is for an SGE scheduler (ARC).</p>
<p>The full script can be found in <a class="reference external" href="https://github.com/lukeconibear/swd6_hpp/blob/main/docs/jobqueue.yaml"><code class="docutils literal notranslate"><span class="pre">~/.config/dask/jobqueue.yaml</span></code></a>.</p>
<p><a class="reference external" href="http://jobqueue.dask.org/en/latest/configurations.html">Here</a> are examples for different HPC systems.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">jobqueue</span><span class="p">:</span>

  <span class="nt">sge</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dask-worker</span>

    <span class="c1"># Dask worker options</span>
    <span class="nt">cores</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>                   <span class="c1"># Total number of cores per job</span>
    <span class="nt">memory</span><span class="p">:</span> <span class="s">&#39;1</span><span class="nv"> </span><span class="s">GB&#39;</span>            <span class="c1"># Total amount of memory per job</span>
    <span class="nt">processes</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>                <span class="c1"># Number of Python processes per job</span>

    <span class="nt">interface</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ib0</span>                       <span class="c1"># Network interface to use like eth0 or ib0</span>
    <span class="nt">death-timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>                    <span class="c1"># Number of seconds to wait if a worker can not find a scheduler</span>
    <span class="nt">local-directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>                <span class="c1"># Location of fast local storage like /scratch or $TMPDIR</span>

    <span class="c1"># SGE resource manager options</span>
    <span class="nt">shebang</span><span class="p">:</span> <span class="s">&quot;#!/usr/bin/env</span><span class="nv"> </span><span class="s">bash&quot;</span>
    <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="nt">project</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="nt">walltime</span><span class="p">:</span> <span class="s">&#39;01:00:00&#39;</span>
    <span class="nt">extra</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="nt">env-extra</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="nt">job-extra</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="nt">log-directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>

    <span class="nt">resource-spec</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>

<span class="nt">distributed</span><span class="p">:</span>
  <span class="nt">worker</span><span class="p">:</span>
    <span class="nt">memory</span><span class="p">:</span>
      <span class="nt">target</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span> <span class="c1"># dont spill to disk</span>
      <span class="nt">spill</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span> <span class="c1"># dont spill to disk</span>
      <span class="nt">pause</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.80</span> <span class="c1"># pause memory execution at 80% use</span>
      <span class="nt">terminate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.95</span> <span class="c1"># restart the worker at 95% use</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h5><strong>Submission script</strong><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<p>The distributed client and cluster are created within a Python script.</p>
<p>The resource requirements per worker are defined, along with the number of workers.</p>
<p>Here, the scheduler and client run as independent jobs, in contrast to Dask-MPI where they go to worker ranks 0 and 1, respectively (reducing the total worker count by 2).</p>
<p>Move the scheduler and client to the login node somehow …</p>
<p>The full script can be found in <a class="reference external" href="https://github.com/lukeconibear/swd6_hpp/blob/main/docs/example_dask_jobqueue_sge.py"><code class="docutils literal notranslate"><span class="pre">example_dask_jobqueue_sge.py</span></code></a> file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">SGECluster</span>


<span class="k">def</span> <span class="nf">setup_client_and_cluster</span><span class="p">(</span>
    <span class="n">number_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;00:01:00&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">1</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup Dask client and cluster.</span>
<span class="sd">    Ensure that the number of workers is the right amount for your job and will be fully utilised.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting up Dask client and cluster ...&quot;</span><span class="p">)</span>
    <span class="n">number_workers</span> <span class="o">=</span> <span class="n">number_processes</span> <span class="o">*</span> <span class="n">number_jobs</span>
    <span class="c1"># these are the requirements for a single worker</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">SGECluster</span><span class="p">(</span>
        <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;ib0&quot;</span><span class="p">,</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">walltime</span><span class="p">,</span>
        <span class="n">memory</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2"> G&quot;</span><span class="p">,</span>
        <span class="n">resource_spec</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;h_vmem=</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2">G&quot;</span><span class="p">,</span>
        <span class="n">scheduler_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dashboard_address&quot;</span><span class="p">:</span> <span class="s2">&quot;:2727&quot;</span><span class="p">},</span>
        <span class="n">job_extra</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;-V&quot;</span><span class="p">,</span>  <span class="c1"># export all environment variables</span>
            <span class="sa">f</span><span class="s2">&quot;-pe smp </span><span class="si">{</span><span class="n">number_processes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;-l disk=</span><span class="si">{</span><span class="n">memory</span><span class="si">}</span><span class="s2">G&quot;</span>
        <span class="p">],</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PWD&quot;</span><span class="p">),</span> <span class="s2">&quot;dask-worker-space&quot;</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="n">number_jobs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The resources of each worker are: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">job_script</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">client</span><span class="p">,</span> <span class="n">cluster</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">client</span><span class="p">,</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">setup_client_and_cluster</span><span class="p">(</span>
        <span class="n">number_processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">number_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;01:00:00&quot;</span><span class="p">,</span>
        <span class="n">memory</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Main processing ...&quot;</span><span class="p">)</span>
    <span class="n">example_function</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished processing.&quot;</span><span class="p">)</span>

    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Closed client and cluster.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h5><strong>Batch job</strong><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>Submit this job to the queue.</p>
<p>This is similar to for Dask-MPI, apart from you don’t need to load the MPI modules, or have the <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> call before executing the Python script.</p>
<p>The full script can be found in <a class="reference external" href="https://github.com/lukeconibear/swd6_hpp/blob/main/docs/example_dask_jobqueue_sge.bash"><code class="docutils literal notranslate"><span class="pre">example_dask_jobqueue_sge.bash</span></code></a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -l</span>
<span class="c1">#$ -cwd -V</span>
<span class="c1">#$ -l h_rt=01:00:00</span>
<span class="c1">#$ -pe smp 1</span>
<span class="c1">#$ -l h_vmem=1G</span>

<span class="c1"># ensure linear algebra libraries using 1 thread</span>
<span class="c1"># https://docs.dask.org/en/stable/array-best-practices.html#avoid-oversubscribing-threads</span>
<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>

conda activate parallelisation_tests

python example_dask_jobqueue_sge.py
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h5><strong>Distributed profiling and diagnostics</strong><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>Similar as for Dask-MPI, you can view the Dask performance report <a class="reference external" href="https://gistcdn.githack.com/lukeconibear/5ae2b1a731541155b993265a8c4a12a9/raw/a8a59aa659c3f64aaccfaf9cb6866ad5527c8ed4/dask-report_jobqueue.html">here</a>.</p>
<p>The Dask-Jobqueue method create and schedules the workers <em>within</em> the Python script. This additional overhead takes extra time relative to Dask-MPI, which has the 8 workers scheduled by the HPC.</p>
</div>
</div>
</div>
<div class="section" id="functions-become-tasks">
<h3>Functions become Tasks<a class="headerlink" href="#functions-become-tasks" title="Permalink to this headline">¶</a></h3>
<div class="section" id="tasks-in-dask">
<h4><a class="reference external" href="https://docs.dask.org/en/stable/futures.html#submit-tasks">Tasks in Dask</a><a class="headerlink" href="#tasks-in-dask" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">double</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>


<span class="n">double</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Submitting this function (task) to the client, runs it in a background thread or process:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">double</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">future</span>
</pre></div>
</div>
</div>
</div>
<p>Return the result of this future object using <code class="docutils literal notranslate"><span class="pre">.result()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>You can also map a function (task) to many inputs using <a class="reference external" href="https://docs.dask.org/en/stable/bag.html">Dask Bags</a>.</p>
<p>Dask Bags allow operations like <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code>, <code class="docutils literal notranslate"><span class="pre">fold</span></code>, and <code class="docutils literal notranslate"><span class="pre">groupby</span></code> on collections of generic Python objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
</pre></div>
</div>
</div>
</div>
<p>You can <a class="reference external" href="https://docs.dask.org/en/stable/bag-creation.html">create Dask Bags</a> from a sequence, reading from files, or from delayed objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bag</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">bag</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doubled_bag</span> <span class="o">=</span> <span class="n">bag</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">double</span><span class="p">)</span>
<span class="n">doubled_bag</span>
</pre></div>
</div>
</div>
</div>
<p>As earlier, call <code class="docutils literal notranslate"><span class="pre">.compute()</span></code> to execute the computation (i.e., the mapped function):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">doubled_bag</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="classes-become-actors">
<h3>Classes become Actors<a class="headerlink" href="#classes-become-actors" title="Permalink to this headline">¶</a></h3>
<p>Actors enable stateful computations. They are pointers to remote objects. You can call methods on these remote objects.</p>
<div class="section" id="actors-in-dask">
<h4><a class="reference external" href="http://distributed.dask.org/en/stable/actors.html">Actors in Dask</a><a class="headerlink" href="#actors-in-dask" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; A simple class to manage an incrementing counter &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<p><a class="reference external" href="http://distributed.dask.org/en/stable/actors.html#create-an-actor">Create an actor</a> on a worker using the <code class="docutils literal notranslate"><span class="pre">actor=True</span></code> keyword argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">Counter</span><span class="p">,</span> <span class="n">actor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Get back a pointer to that object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">counter</span>
</pre></div>
</div>
</div>
</div>
<p>Then <a class="reference external" href="http://distributed.dask.org/en/stable/actors.html#call-remote-methods">call the remote method</a> on that pointer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="n">future</span>
</pre></div>
</div>
</div>
</div>
<p>And return the result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="ray">
<h3><a class="reference external" href="https://www.ray.io/">Ray</a><a class="headerlink" href="#ray" title="Permalink to this headline">¶</a></h3>
<p>Another great library for parallel computing in Python is <strong>Ray</strong>.</p>
<p>Ray provides a simple, universal API for building distributed applications.</p>
<p>Ray will automatically detect the available GPUs and CPUs on the machine.</p>
<p>You can also <a class="reference external" href="https://docs.ray.io/en/latest/walkthrough.html#specifying-required-resources">specify required resources</a>.</p>
<p>First, initialise Ray.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Ray has many great features, similar to Dask.</p>
<p>This includes:</p>
<div class="section" id="tasks-in-ray">
<h4><a class="reference external" href="https://docs.ray.io/en/latest/ray-overview/index.html#parallelizing-python-java-functions-with-ray-tasks">Tasks in Ray</a><a class="headerlink" href="#tasks-in-ray" title="Permalink to this headline">¶</a></h4>
<p>Parallelise functions by adding <code class="docutils literal notranslate"><span class="pre">&#64;ray.remote</span></code> decorator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Then instead of calling it normally, use the <code class="docutils literal notranslate"><span class="pre">.remote()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>This yields a future object reference that you can retrieve with <code class="docutils literal notranslate"><span class="pre">ray.get(object)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="actors-in-ray">
<h4><a class="reference external" href="https://docs.ray.io/en/latest/actors.html">Actors in Ray</a><a class="headerlink" href="#actors-in-ray" title="Permalink to this headline">¶</a></h4>
<p>Classes (actors) are parallelised in the same way as functions (tasks) in Ray i.e., by using the <code class="docutils literal notranslate"><span class="pre">&#64;ray.remote</span></code> decorator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; A simple class to manage an incrementing counter &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
    
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<p>Similar to before, construct an actor instance using <code class="docutils literal notranslate"><span class="pre">.remote()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counters</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>On each actor, call remote methods (<code class="docutils literal notranslate"><span class="pre">increment</span></code> and <code class="docutils literal notranslate"><span class="pre">read</span></code>), and get the future objects</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">]</span>

<span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">counter</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span> <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="n">counters</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">futures</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Other key features of Ray:</p>
</div>
<div class="section" id="ray-put">
<h4><code class="docutils literal notranslate"><span class="pre">ray.put()</span></code><a class="headerlink" href="#ray-put" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Put a value in the distributed object store.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">put_id</span> <span class="pre">=</span> <span class="pre">ray.put(my_object)</span></code></p></li>
</ul>
</div>
<div class="section" id="ray-get">
<h4><code class="docutils literal notranslate"><span class="pre">ray.get()</span></code><a class="headerlink" href="#ray-get" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Get an object from the distributed object store, either placed there by <code class="docutils literal notranslate"><span class="pre">ray.put()</span></code> explicitly or by a task or actor method, blocking until object is available.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thing</span> <span class="pre">=</span> <span class="pre">ray.get(put_id)</span></code></p></li>
</ul>
</div>
<div class="section" id="ray-wait">
<h4><code class="docutils literal notranslate"><span class="pre">ray.wait()</span></code><a class="headerlink" href="#ray-wait" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Wait on a list of ids until one of the corresponding objects is available (e.g., the task completes). Return two lists, one with ids for the available objects and the other with ids for the still-running tasks or method calls.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">finished,</span> <span class="pre">running</span> <span class="pre">=</span> <span class="pre">ray.wait([train_id,</span> <span class="pre">track_id])</span></code></p></li>
</ul>
</div>
<div class="section" id="ray-s-multiprocessing">
<h4>Ray’s <a class="reference external" href="https://docs.ray.io/en/latest/multiprocessing.html"><code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code></a><a class="headerlink" href="#ray-s-multiprocessing" title="Permalink to this headline">¶</a></h4>
<p>To scale beyond one machine and generally manage a pool of processes.</p>
<p>Replace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">Pool</span>
</pre></div>
</div>
<p>With:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray.util.multiprocessing.pool</span> <span class="kn">import</span> <span class="n">Pool</span>
</pre></div>
</div>
<p>When finished, remember to shut down the Ray connection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ray</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="parallel-numba">
<h2><a class="reference external" href="https://numba.readthedocs.io/en/stable/user/performance-tips.html#parallel-true">Parallel Numba</a><a class="headerlink" href="#parallel-numba" title="Permalink to this headline">¶</a></h2>
<p>If code contains operations that are parallelisable (and <a class="reference external" href="https://numba.readthedocs.io/en/stable/user/parallel.html#numba-parallel-supported">supported</a>) Numba can compile a version that will run in parallel on multiple threads.</p>
<p>This parallelisation is performed automatically and is enabled by simply adding the keyword agurment <code class="docutils literal notranslate"><span class="pre">parallel=True</span></code> to <code class="docutils literal notranslate"><span class="pre">&#64;njit</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.e7</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ident_parallel</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">ident_parallel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ident_parallel</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it
<span class="n">ident_parallel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h2>
<p>…</p>
</div>
<div class="section" id="further-information">
<h2>Further information<a class="headerlink" href="#further-information" title="Permalink to this headline">¶</a></h2>
<div class="section" id="useful-resources">
<h3>Useful resources<a class="headerlink" href="#useful-resources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://examples.dask.org/">More Dask examples</a></p></li>
<li><p><a class="reference external" href="http://jobqueue.dask.org/en/latest/debug.html">How to debug Dask jobqueue</a></p></li>
<li><p><a class="reference external" href="http://distributed.dask.org/en/stable/diagnosing-performance.html">Diagnosing performance</a></p></li>
<li><p>…</p></li>
</ul>
</div>
<div class="section" id="good-practises">
<h3>Good practises<a class="headerlink" href="#good-practises" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Start small.</p></li>
<li><p>Test out ideas locally first, on laptop (or other single machine).</p></li>
<li><p>Avoid very large chunks / partitions / task graphs (a good first option is to allow auto-chunking).</p></li>
<li><p>Only use parallelisation (e.g., Dask) when needed, then move back to normal Python ( / NumPy / Pandas).</p></li>
<li><p>Persist data in memory (RAM) where can, as faster than accessing from disk.</p></li>
<li><p>Load data with the parallel library (e.g., Dask), rather than just passing data to it to manage.</p></li>
<li><p>Call compute once, on lots of computations.</p></li>
<li><p>Avoid global state.</p></li>
<li><p>Don’t modify the data in place.</p></li>
<li><p>Avoid moving large pieces of data around (i.e., bring analysis to the data on the cluster).</p></li>
<li><p>More information:</p>
<ul>
<li><p><a class="reference external" href="https://docs.dask.org/en/stable/best-practices.html">Dask</a>, <a class="reference external" href="https://docs.dask.org/en/stable/array-best-practices.html">Dask Array</a>, <span class="xref myst">Dask DataFrame</span>
<a class="reference external" href="https://docs.dask.org/en/stable/delayed-best-practices.html">Dask Delayed</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="other-options">
<h3>Other options<a class="headerlink" href="#other-options" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/dask-on-ray.html">Dask on Ray</a></p>
<ul>
<li><p>Use Ray as a backend for Dask tasks.</p></li>
<li><p>Dask dispatches tasks to Ray for scheduling and execution.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://modin.readthedocs.io/en/latest/">Modin</a></p>
<ul>
<li><p>Swap out the library import and use the same API.</p></li>
<li><p>Uses Ray or Dask to easily speed up your Pandas code.</p></li>
<li><p>To use Modin, simply replace the import and use Pandas API as normal.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.pymars.org/en/latest/">Mars</a></p>
<ul>
<li><p>A tensor-based unified framework for large-scale data computation which scales numpy, pandas, scikit-learn and many other libraries.</p></li>
<li><p>Swap out the library import, use the same API, and add <code class="docutils literal notranslate"><span class="pre">.execute()</span></code>.</p></li>
<li><p><a class="reference external" href="https://docs.pymars.org/en/latest/getting_started/tensor.html">Mars Tensor</a> for NumPy.</p></li>
<li><p><a class="reference external" href="https://docs.pymars.org/en/latest/getting_started/dataframe.html">Mars DataFrame</a> for Pandas.</p></li>
<li><p>Mars can also use Ray as the backend (<a class="reference external" href="https://docs.ray.io/en/latest/data/mars-on-ray.html">instructions</a>).</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.pola.rs/">Polars</a></p>
<ul>
<li><p>Lightning-fast DataFrame library for Rust and Python.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://docs.ray.io/en/latest/data/raydp.html">RayDP</a></p>
<ul>
<li><p>Combines your Spark and Ray clusters, making it easy to do large scale data processing using the PySpark API and seemlessly use that data to train your models using TensorFlow and PyTorch.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://ipyparallel.readthedocs.io/en/latest/">IPython Parallel</a></p>
<ul>
<li><p>For stateful remote control of several running ipython sessions.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://hadoop.apache.org/docs/r1.2.1/streaming.html">Hadoop Streaming</a></p>
<ul>
<li><p>For batch processing using MapReduce from <a class="reference external" href="https://hadoop.apache.org/">Hadoop</a>.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://spark.apache.org/docs/latest/api/python/">PySpark</a></p>
<ul>
<li><p>For using <a class="reference external" href="https://spark.apache.org/">Apache Spark</a> in Python, an all-in-one MapShuffleReduce system.</p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/spark.html">How Dask compares with Spark</a>.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://streamparse.readthedocs.io/en/latest/index.html">streamparse</a></p>
<ul>
<li><p>For real-time streaming of data using <a class="reference external" href="https://storm.apache.org/">Apache Storm</a>.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://eliot.readthedocs.io/en/stable/scientific-computing.html">Using eliot with Dask</a></p></li>
</ul>
</div>
<div class="section" id="resources">
<h3>Resources<a class="headerlink" href="#resources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://youtu.be/18B1pznaU1o">Concurrency</a> can also run different tasks together, but work is not done at the same time (<a class="reference external" href="https://youtu.be/MCs5OvhV9S4">concurrency from the ground up</a>).</p></li>
<li><p><a class="reference external" href="https://youtu.be/iG6fr81xHKA">Asynchronous</a> (multi-threading), useful for massive scaling, threads controlled explicitly.</p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "swd6_hpp"
        },
        kernelOptions: {
            kernelName: "swd6_hpp",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'swd6_hpp'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="04_compilers.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Compilers</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="06_GPUs.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">GPUs</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Luke Conibear<br/>
        
            &copy; Copyright 2022.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>